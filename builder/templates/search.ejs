<link rel="stylesheet" type="text/css" href="/assets/libs/select2/dist/css/select2.min.css" />
<link rel="stylesheet" type="text/css" href="/assets/libs/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css"/>        
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.1/dist/bootstrap-table.min.css">
<div class="card">
    <form id="<%=model.modelName%>Form" class="form-horizontal">
        <div class="card-body">
            <h4 class="card-title"><%%= __('MODEL_<%=model.modelName%>') %%></h4>
            <% for (let index = 0; index < Object.keys(model.schema.paths).length; index++) { %>
                <% let key = Object.keys(model.schema.paths)[index] %>
                <% const path = model.schema.paths[key];%>
                <% if (index % 2 == 0) { %>
                <div class="row">
                <% } %>
                    <div class="form-group row col-md-6">
                        <label for="<%= path.path %>" class="col-sm-3 text-end control-label col-form-label"><%%= __('MODEL_<%=model.modelName%>_<%=path.path%>')%%></label>
                        <div class="col-sm-9">
                        <% if (path.options.combo && path.options.combo.multiple) { %>
                            <select id="<%= path.path %>" name="<%= path.path%>" class="select2 form-select shadow-none" multiple="multiple" style="width: 100%; height: 36px" <%= path.options.readOnly ? 'disabled' : ''%> >
                            <%% model.schema.paths['<%=path.path%>'].options.combo.values.forEach(v => { %%>
                                <option <%%= locals.object && object["<%=path.path%>"].includes(v.value) ? 'selected' : '' %%> value="<%%=v.value%%>"><%%=v.text%%></option>
                            <%% }) %%>
                            </select>
                        <% } else if (path.options.combo) { %>
                            <select id="<%= path.path %>" name="<%= path.path%>" class="select2 form-select shadow-none" style="width: 100%; height: 36px" <%= path.options.readOnly ? 'disabled' : ''%> >
                                <option value=""></option>
                            <%% model.schema.paths['<%=path.path%>'].options.combo.values.forEach(v => { %%>
                                <option <%%= locals.object && object["<%=path.path%>"] == v.value ? 'selected' : '' %%> value="<%%=v.value%%>"><%%=v.text%%></option>
                            <%% }) %%>
                            </select>
                        <% } else if (path.options.type.name == 'Boolean') { %>
                            <select id="<%= path.path %>" name="<%= path.path%>" class="select2 form-select shadow-none" style="width: 100%; height: 36px" <%= path.options.readOnly ? 'disabled' : ''%>>
                                <option <%%= locals.object && object["<%=path.path%>"] ? 'selected' : '' %%> value="true"><%%= __('BOOLEAN_true') %%></option>
                                <option <%%= locals.object && !object["<%=path.path%>"] ? 'selected' : '' %%> value="false"><%%= __('BOOLEAN_false') %%></option>
                            </select> 
                        <% } else if (path.options.type.name == 'Date') { %>
                            <div class="input-group">
                                <input type="text" class="form-control mydatepicker" placeholder="<%%=__('DATE_FORMAT')%>" id="<%= path.path %>" name="<%= path.path%>" <%= path.options.readOnly ? 'disabled' : ''%> value="<%%= locals.object ? object['<%=path.path%>'] : '' %%>" />
                                <div class="input-group-append">
                                    <span class="input-group-text h-100"><i class="mdi mdi-calendar"></i></span>
                                </div>
                            </div>                                    
                        <% } else if (path.options.type.name == 'Number') { %>
                            <input type="number" class="form-control" id="<%= path.path %>" name="<%= path.path%>" placeholder="" <%= path.options.readOnly ? 'disabled' : ''%> value='<%%= locals.object ? object['<%=path.path%>'] : '' %%>'/>
                        <% } else if (path.options.password) { %>
                            <input type="password" class="form-control" id="<%= path.path %>" name="<%= path.path%>" placeholder="" <%= path.options.readOnly ? 'disabled' : ''%> value="<%%= locals.object ? object['<%=path.path%>'] : '' %%>"/>
                        <% } else if (path.options.fileUpload) { %>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="<%= path.path %>" name="<%= path.path%>" required />
                            </div>
                        <% } else { %>
                            <input type="text" class="form-control" id="<%= path.path %>" name="<%= path.path%>" placeholder="" <%= path.options.readOnly ? 'disabled' : ''%> value="<%%= locals.object ? object['<%=path.path%>'] : '' %%>"/>
                        <% } %>
                        </div>
                    </div>
                <% if (index % 2 != 0) { %>
                </div>
                <% } %>                            
            <% } %>
            <div class="border-top">
                <div class="card-body">
                    <button id="<%=model.modelName%>Form_search_btn" type="button" class="btn btn-primary"><%%= __('SEARCH') %></button>
                </div>
            </div>
        </div>
    </form>
</div>
<div class="card">
    <div class="card-body">
        <h5 class="card-title"><%=model.modelName%></h5>
        <div class="table-responsive">
            <table id="table" 
                data-toggle="table"
                class="table table-striped table-bordered clickable"
                detail-url="<%= params.view == '' ? '' : '/' + params.view %>/<%=model.modelName.toLowerCase()%>/"
                >
                <thead>
                    <tr>
    <%  Object.keys(model.schema.paths).forEach(element => { var path = model.schema.paths[element] %>
    <% if (!path.options.hideInForm) { %>
                        <th data-field="<%=path.path%>"><%%= __('COL_<%=path.path%>') %%></th>
    <% }})%>
                        <th data-field="id" data-formatter="actionFormatter" data-events="actionEvents"><%%= __('COL_actions') %%></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/bootstrap-table@1.21.1/dist/bootstrap-table.min.js"></script>
    
<script>
function actionFormatter(value, row, index) {
  return [
    '<a class="view" href="/<%=params.view != "" ? params.view + "/" : ""%><%=model.modelName.toLowerCase()%>/' + row._id + '" title="">',
    '<i class="fa fa-eye"></i>',
    '</a> ',
    '<a class="delete" href="javascript:void(0)" title="">',
        '<i class="fa fa-trash"></i>',
        '</a> ',        
  ].join('');
}

window.actionEvents = {    
  'click .delete' : function (e, value, row, index) {
    e.stopPropagation()
    $.ajax({
            type: 'DELETE',
            url: `/api/<%=model.modelName%>/${row._id}`,
            dataType: 'json',
            success: function(data) {
                toastr.success("<%%= __('APP_NAME') %%>", "<%%= __('DELETE_SUCCESS') %%>")
                $('#table').bootstrapTable('refresh')
            },
            error: function(error) {
                console.log('error');
                console.error(error);
            },
        });
  },
}

jQuery('#<%=model.modelName%>Form_search_btn').click(() => {
    var data = $('#<%=model.modelName%>Form').serialize();
    $.ajax({
        type: 'POST',
        url: '/api/<%=model.modelName.toLowerCase()%>/find',
        data: data,
        dataType: 'json',
        success: function(data) {
            $('#table').bootstrapTable('load', data)
        },
        error: function(error) {
            console.error(error);
            toastr.error("<%%= __('SEARCH_ERROR') %>", "<%%= __('APP_NAME') %>")
        },
    });
})

</script>
                
