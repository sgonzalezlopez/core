<link rel="stylesheet" type="text/css" href="/assets/libs/select2/dist/css/select2.min.css" />
<link rel="stylesheet" type="text/css" href="/assets/libs/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css"/>        
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.1/dist/bootstrap-table.min.css">
<div class="card">
    <form id="AppForm" class="form-horizontal">
        <div class="card-body">
            <h4 class="card-title"><%= __('MODEL_App') %></h4>
                <div class="row">
                    <div class="form-group row col-md-6">
                        <label for="name" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_name')%></label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="name" name="name" placeholder=""  value="<%= locals.object ? object['name'] : '' %>"/>
                        </div>
                    </div>
                    <div class="form-group row col-md-6">
                        <label for="type" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_type')%></label>
                        <div class="col-sm-9">
                            <select id="type" name="type" class="select2 form-select shadow-none" multiple="multiple" style="width: 100%; height: 36px"  >
                            <% model.schema.paths['type'].options.combo.values.forEach(v => { %>
                                <option <%= locals.object && object["type"].includes(v.value) ? 'selected' : '' %> value="<%=v.value%>"><%=v.text%></option>
                            <% }) %>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group row col-md-6">
                        <label for="roles" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_roles')%></label>
                        <div class="col-sm-9">
                            <select id="roles" name="roles" class="select2 form-select shadow-none" multiple="multiple" style="width: 100%; height: 36px"  >
                            <% model.schema.paths['roles'].options.combo.values.forEach(v => { %>
                                <option <%= locals.object && object["roles"].includes(v.value) ? 'selected' : '' %> value="<%=v.value%>"><%=v.text%></option>
                            <% }) %>
                            </select>
                        </div>
                    </div>
                    <div class="form-group row col-md-6">
                        <label for="level" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_level')%></label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="level" name="level" placeholder=""  value='<%= locals.object ? object['level'] : '' %>'/>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group row col-md-6">
                        <label for="link" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_link')%></label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="link" name="link" placeholder=""  value="<%= locals.object ? object['link'] : '' %>"/>
                        </div>
                    </div>
                    <div class="form-group row col-md-6">
                        <label for="icon" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_icon')%></label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="icon" name="icon" placeholder=""  value="<%= locals.object ? object['icon'] : '' %>"/>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group row col-md-6">
                        <label for="parent" class="col-sm-3 text-end control-label col-form-label"><%= __('MODEL_App_parent')%></label>
                        <div class="col-sm-9">
                            <select id="parent" name="parent" class="select2 form-select shadow-none" style="width: 100%; height: 36px"  >
                                <option value=""></option>
                            <% model.schema.paths['parent'].options.combo.values.forEach(v => { %>
                                <option <%= locals.object && object["parent"] == v.value ? 'selected' : '' %> value="<%=v.value%>"><%=v.text%></option>
                            <% }) %>
                            </select>
                        </div>
                    </div>
            <div class="border-top">
                <div class="card-body">
                    <button id="AppForm_search_btn" type="button" class="btn btn-primary"><%= __('SEARCH') %></button>
                </div>
            </div>
        </div>
    </form>
</div>
<div class="card">
    <div class="card-body">
        <h5 class="card-title">App</h5>
        <div class="table-responsive">
            <table id="table" 
                data-toggle="table"
                class="table table-striped table-bordered clickable"
                detail-url="/admin/app/"
                >
                <thead>
                    <tr>
                        <th data-field="name"><%= __('COL_name') %></th>
                        <th data-field="type"><%= __('COL_type') %></th>
                        <th data-field="roles"><%= __('COL_roles') %></th>
                        <th data-field="level"><%= __('COL_level') %></th>
                        <th data-field="link"><%= __('COL_link') %></th>
                        <th data-field="icon"><%= __('COL_icon') %></th>
                        <th data-field="parent"><%= __('COL_parent') %></th>
                        <th data-field="id" data-formatter="actionFormatter" data-events="actionEvents"><%= __('COL_actions') %></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
<script src="https://unpkg.com/bootstrap-table@1.21.1/dist/bootstrap-table.min.js"></script>
<script>
function actionFormatter(value, row, index) {
  return [
    '<a class="view" href="/admin/app/' + row._id + '" title="">',
    '<i class="fa fa-eye"></i>',
    '</a> ',
    '<a class="delete" href="javascript:void(0)" title="">',
        '<i class="fa fa-trash"></i>',
        '</a> ',        
  ].join('');
}
window.actionEvents = {    
  'click .delete' : function (e, value, row, index) {
    e.stopPropagation()
    $.ajax({
            type: 'DELETE',
            url: `/api/App/${row._id}`,
            dataType: 'json',
            success: function(data) {
                toastr.success("<%= __('APP_NAME') %>", "<%= __('DELETE_SUCCESS') %>")
                $('#table').bootstrapTable('refresh')
            },
            error: function(error) {
                console.log('error');
                console.error(error);
            },
        });
  },
}
jQuery('#AppForm_search_btn').click(() => {
    var data = $('#AppForm').serialize();
    $.ajax({
        type: 'POST',
        url: '/api/app/find',
        data: data,
        dataType: 'json',
        success: function(data) {
            $('#table').bootstrapTable('load', data)
        },
        error: function(error) {
            console.error(error);
            toastr.error("<%= __('SEARCH_ERROR') %>", "<%= __('APP_NAME') %>")
        },
    });
})
</script>